<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>01 | Nginx：高性能的 Web 服务器 | NOTE-BOOK2</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/notebook/favicon.ico">
    <link rel="manifest" href="/notebook/manifest.json">
    <meta name="description" content="note-book 的第二分仓笔记仓库">
    
    <link rel="preload" href="/notebook/assets/css/0.styles.36b9479e.css" as="style"><link rel="preload" href="/notebook/assets/js/app.b6298c27.js" as="script"><link rel="preload" href="/notebook/assets/js/2.64eb5107.js" as="script"><link rel="preload" href="/notebook/assets/js/41.e918a100.js" as="script"><link rel="preload" href="/notebook/assets/js/50.da39fd24.js" as="script"><link rel="prefetch" href="/notebook/assets/js/10.f2f15088.js"><link rel="prefetch" href="/notebook/assets/js/100.b7a284fd.js"><link rel="prefetch" href="/notebook/assets/js/101.54042053.js"><link rel="prefetch" href="/notebook/assets/js/102.5bab3651.js"><link rel="prefetch" href="/notebook/assets/js/103.3d283f19.js"><link rel="prefetch" href="/notebook/assets/js/104.2fbe9651.js"><link rel="prefetch" href="/notebook/assets/js/105.3e2ec64c.js"><link rel="prefetch" href="/notebook/assets/js/106.25ccda3b.js"><link rel="prefetch" href="/notebook/assets/js/107.90cc2754.js"><link rel="prefetch" href="/notebook/assets/js/108.4e4472c8.js"><link rel="prefetch" href="/notebook/assets/js/109.8c927ccc.js"><link rel="prefetch" href="/notebook/assets/js/11.57132374.js"><link rel="prefetch" href="/notebook/assets/js/110.6e9ab0a5.js"><link rel="prefetch" href="/notebook/assets/js/111.cf4db3b8.js"><link rel="prefetch" href="/notebook/assets/js/112.db9efc72.js"><link rel="prefetch" href="/notebook/assets/js/113.bc497656.js"><link rel="prefetch" href="/notebook/assets/js/114.7b29fa0f.js"><link rel="prefetch" href="/notebook/assets/js/115.6ecd72ad.js"><link rel="prefetch" href="/notebook/assets/js/116.714ba37d.js"><link rel="prefetch" href="/notebook/assets/js/117.20fc6ca9.js"><link rel="prefetch" href="/notebook/assets/js/118.23c68cc5.js"><link rel="prefetch" href="/notebook/assets/js/119.22353b91.js"><link rel="prefetch" href="/notebook/assets/js/12.e186564a.js"><link rel="prefetch" href="/notebook/assets/js/13.8f2e6b3f.js"><link rel="prefetch" href="/notebook/assets/js/14.5af7e630.js"><link rel="prefetch" href="/notebook/assets/js/15.2ee25eab.js"><link rel="prefetch" href="/notebook/assets/js/16.0f760848.js"><link rel="prefetch" href="/notebook/assets/js/17.82010583.js"><link rel="prefetch" href="/notebook/assets/js/18.94bb2fcd.js"><link rel="prefetch" href="/notebook/assets/js/19.8d83e367.js"><link rel="prefetch" href="/notebook/assets/js/20.9853e81d.js"><link rel="prefetch" href="/notebook/assets/js/21.a60e512a.js"><link rel="prefetch" href="/notebook/assets/js/22.0a718618.js"><link rel="prefetch" href="/notebook/assets/js/23.d0085c3c.js"><link rel="prefetch" href="/notebook/assets/js/24.64c99be0.js"><link rel="prefetch" href="/notebook/assets/js/25.7f138222.js"><link rel="prefetch" href="/notebook/assets/js/26.c38b4f1f.js"><link rel="prefetch" href="/notebook/assets/js/27.3c23ee36.js"><link rel="prefetch" href="/notebook/assets/js/28.17a30eb5.js"><link rel="prefetch" href="/notebook/assets/js/29.1080ae7e.js"><link rel="prefetch" href="/notebook/assets/js/3.39c53e9a.js"><link rel="prefetch" href="/notebook/assets/js/30.e12e7194.js"><link rel="prefetch" href="/notebook/assets/js/31.1b4d10d3.js"><link rel="prefetch" href="/notebook/assets/js/32.088b464e.js"><link rel="prefetch" href="/notebook/assets/js/33.b6d5b301.js"><link rel="prefetch" href="/notebook/assets/js/34.07a7bd18.js"><link rel="prefetch" href="/notebook/assets/js/35.c1778ec0.js"><link rel="prefetch" href="/notebook/assets/js/36.9c952bcf.js"><link rel="prefetch" href="/notebook/assets/js/37.538120d6.js"><link rel="prefetch" href="/notebook/assets/js/38.379b1ac9.js"><link rel="prefetch" href="/notebook/assets/js/39.9825dc44.js"><link rel="prefetch" href="/notebook/assets/js/4.80b43ba9.js"><link rel="prefetch" href="/notebook/assets/js/40.7502629c.js"><link rel="prefetch" href="/notebook/assets/js/42.6d79fd40.js"><link rel="prefetch" href="/notebook/assets/js/43.f40c79b3.js"><link rel="prefetch" href="/notebook/assets/js/44.66b4fb8b.js"><link rel="prefetch" href="/notebook/assets/js/45.58d7b7db.js"><link rel="prefetch" href="/notebook/assets/js/46.3e86cb70.js"><link rel="prefetch" href="/notebook/assets/js/47.1ceb15d6.js"><link rel="prefetch" href="/notebook/assets/js/48.7405fe2c.js"><link rel="prefetch" href="/notebook/assets/js/49.f512df2d.js"><link rel="prefetch" href="/notebook/assets/js/5.a817fe71.js"><link rel="prefetch" href="/notebook/assets/js/51.1befb9db.js"><link rel="prefetch" href="/notebook/assets/js/52.ee2cc35e.js"><link rel="prefetch" href="/notebook/assets/js/53.b7d4d642.js"><link rel="prefetch" href="/notebook/assets/js/54.7597b610.js"><link rel="prefetch" href="/notebook/assets/js/55.b99d68c9.js"><link rel="prefetch" href="/notebook/assets/js/56.3260f107.js"><link rel="prefetch" href="/notebook/assets/js/57.4c3d32ae.js"><link rel="prefetch" href="/notebook/assets/js/58.858f5030.js"><link rel="prefetch" href="/notebook/assets/js/59.5bb43d22.js"><link rel="prefetch" href="/notebook/assets/js/6.e66ff3e3.js"><link rel="prefetch" href="/notebook/assets/js/60.604f3715.js"><link rel="prefetch" href="/notebook/assets/js/61.133da1fe.js"><link rel="prefetch" href="/notebook/assets/js/62.b9d97f09.js"><link rel="prefetch" href="/notebook/assets/js/63.b54ac379.js"><link rel="prefetch" href="/notebook/assets/js/64.11aa21b9.js"><link rel="prefetch" href="/notebook/assets/js/65.f7fc56f3.js"><link rel="prefetch" href="/notebook/assets/js/66.11cdb117.js"><link rel="prefetch" href="/notebook/assets/js/67.c393eaf5.js"><link rel="prefetch" href="/notebook/assets/js/68.ee9541b2.js"><link rel="prefetch" href="/notebook/assets/js/69.d3d86051.js"><link rel="prefetch" href="/notebook/assets/js/7.cf57fdd5.js"><link rel="prefetch" href="/notebook/assets/js/70.8466e474.js"><link rel="prefetch" href="/notebook/assets/js/71.e4c9766c.js"><link rel="prefetch" href="/notebook/assets/js/72.efa3abc7.js"><link rel="prefetch" href="/notebook/assets/js/73.534593d2.js"><link rel="prefetch" href="/notebook/assets/js/74.74bf2cc7.js"><link rel="prefetch" href="/notebook/assets/js/75.84a69486.js"><link rel="prefetch" href="/notebook/assets/js/76.6a4151a2.js"><link rel="prefetch" href="/notebook/assets/js/77.bc69de12.js"><link rel="prefetch" href="/notebook/assets/js/78.ef857f92.js"><link rel="prefetch" href="/notebook/assets/js/79.a994a308.js"><link rel="prefetch" href="/notebook/assets/js/8.1e1b7412.js"><link rel="prefetch" href="/notebook/assets/js/80.bb3ad06d.js"><link rel="prefetch" href="/notebook/assets/js/81.65c1333d.js"><link rel="prefetch" href="/notebook/assets/js/82.261800cd.js"><link rel="prefetch" href="/notebook/assets/js/83.44998c31.js"><link rel="prefetch" href="/notebook/assets/js/84.85b6a88a.js"><link rel="prefetch" href="/notebook/assets/js/85.9a33a277.js"><link rel="prefetch" href="/notebook/assets/js/86.1d5b478f.js"><link rel="prefetch" href="/notebook/assets/js/87.a2ea9583.js"><link rel="prefetch" href="/notebook/assets/js/88.aa84de6d.js"><link rel="prefetch" href="/notebook/assets/js/89.9f568c0c.js"><link rel="prefetch" href="/notebook/assets/js/9.bfb9d1de.js"><link rel="prefetch" href="/notebook/assets/js/90.83f66c97.js"><link rel="prefetch" href="/notebook/assets/js/91.7eec9066.js"><link rel="prefetch" href="/notebook/assets/js/92.edafca68.js"><link rel="prefetch" href="/notebook/assets/js/93.a12f5c78.js"><link rel="prefetch" href="/notebook/assets/js/94.bdaa08e2.js"><link rel="prefetch" href="/notebook/assets/js/95.37064771.js"><link rel="prefetch" href="/notebook/assets/js/96.610fe9bd.js"><link rel="prefetch" href="/notebook/assets/js/97.5f6322c4.js"><link rel="prefetch" href="/notebook/assets/js/98.175c6f9c.js"><link rel="prefetch" href="/notebook/assets/js/99.e9545cc8.js">
    <link rel="stylesheet" href="/notebook/assets/css/0.styles.36b9479e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><img src="/notebook/mlogo.svg" alt="NOTE-BOOK2" class="logo"> <span class="site-name can-hide">NOTE-BOOK2</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/monitor-tuning/" class="nav-link">
  JAVA 生产环境下性能监控与调优详解
</a></div><div class="nav-item"><a href="/notebook/http-protocol/" class="nav-link router-link-active">
  透视 HTTP 协议
</a></div><div class="nav-item"><a href="/notebook/ddd/" class="nav-link">
  DDD 实战课
</a></div> <a href="https://github.com/nianien/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook/monitor-tuning/" class="nav-link">
  JAVA 生产环境下性能监控与调优详解
</a></div><div class="nav-item"><a href="/notebook/http-protocol/" class="nav-link router-link-active">
  透视 HTTP 协议
</a></div><div class="nav-item"><a href="/notebook/ddd/" class="nav-link">
  DDD 实战课
</a></div> <a href="https://github.com/nianien/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/notebook/http-protocol/" aria-current="page" class="sidebar-link">透视 HTTP 协议</a></li><li><a href="/notebook/http-protocol/01/" class="sidebar-link">01 | 开篇: To Be a HTTP Hero</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/02/" class="sidebar-heading clickable"><span>02 | 破冰篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/03/" class="sidebar-heading clickable"><span>03 | 基础篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/04/" class="sidebar-heading clickable"><span>04 | 进阶篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/05/" class="sidebar-heading clickable"><span>05 | 安全篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/06/" class="sidebar-heading clickable"><span>06 | 飞翔篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/07/" class="sidebar-heading clickable router-link-active open"><span>07 | 探索篇</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/http-protocol/07/01.html" aria-current="page" class="active sidebar-link">01 | Nginx：高性能的 Web 服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/http-protocol/07/01.html#进程池" class="sidebar-link">进程池</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/07/01.html#i-o-多路复用" class="sidebar-link">I/O 多路复用</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/07/01.html#多阶段处理" class="sidebar-link">多阶段处理</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/07/01.html#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/07/01.html#课下作业" class="sidebar-link">课下作业</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/07/01.html#拓展阅读" class="sidebar-link">拓展阅读</a></li></ul></li><li><a href="/notebook/http-protocol/07/02.html" class="sidebar-link">02 | OpenResty：更灵活的 Web 服务器</a></li><li><a href="/notebook/http-protocol/07/03.html" class="sidebar-link">03 | WAF：保护我们的网络服务</a></li><li><a href="/notebook/http-protocol/07/04.html" class="sidebar-link">04 | CDN：加速我们的网络服务</a></li><li><a href="/notebook/http-protocol/07/05.html" class="sidebar-link">05 | WebSocket：沙盒里的 TCP</a></li></ul></section></li><li><a href="/notebook/http-protocol/08/" class="sidebar-link">08 | 总结篇: HTTP 性能优化面面观</a></li><li><a href="/notebook/http-protocol/09.html" class="sidebar-link">参考资源</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_01-nginx-高性能的-web-服务器"><a href="#_01-nginx-高性能的-web-服务器" class="header-anchor">#</a> 01 | Nginx：高性能的 Web 服务器</h1> <p>经过前面几大模块的学习，你已经完全掌握了 HTTP 的所有知识，那么接下来请收拾一下行囊，整理一下装备，跟我一起去探索 HTTP 之外的广阔天地。</p> <p>现在的互联网非常发达，用户越来越多，网速越来越快，HTTPS 的安全加密、HTTP/2 的多路复用等特性都对 Web 服务器提出了非常高的要求。一个好的 Web 服务器必须要具备稳定、快速、易扩展、易维护等特性，才能够让网站立于不败之地。</p> <p>那么，在搭建网站的时候，应该选择什么样的服务器软件呢？</p> <p>在开头的几讲里我也提到过，Web 服务器就那么几款，目前市面上主流的只有两个：Apache 和 Nginx，两者合计占据了近 90% 的市场份额。</p> <p>今天我要说的就是其中的 Nginx，它是 Web 服务器的“后起之秀”，虽然比 Apache 小了 10 岁，但增长速度十分迅猛，已经达到了与 Apache 平起平坐的地位，而在 Top Million 网站中更是超过了 Apache，拥有超过 50% 的用户（<a href="https://w3techs.com/technologies/cross/web_server/ranking" target="_blank" rel="noopener noreferrer">参考数据<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p> <p><img src="/notebook/assets/img/c5df0592cc8aef91ba961f7fab5a4a0b.c5df0592.png" alt="img"></p> <p>在这里必须要说一下 Nginx 的正确发音，它应该读成 <code>Engine X</code> ，但我个人感觉 X 念起来太拗口，还是比较倾向于读做 <code>Engine ks</code> ，这也与 UNIX、Linux 的发音一致。</p> <p>作为一个 Web 服务器，Nginx 的功能非常完善，完美支持 HTTP/1、HTTPS 和 HTTP/2，而且还在不断进步。当前的主线版本已经发展到了 1.17，正在进行 HTTP/3 的研发，或许一年之后就能在 Nginx 上跑 HTTP/3 了。</p> <p>Nginx 也是我个人的主要研究领域，我也写过相关的书，按理来说今天的课程应该是“手拿把攥”，但真正动笔的时候还是有些犹豫的：很多要点都已经在书里写过了，这次的专栏如果再重复相同的内容就不免有“骗稿费”的嫌疑，应该有些“不一样的东西”。</p> <p>所以我决定抛开书本，换个角度，结合 HTTP 协议来讲 Nginx，带你窥视一下 HTTP 处理的内幕，看看 Web 服务器的工作原理。</p> <h2 id="进程池"><a href="#进程池" class="header-anchor">#</a> 进程池</h2> <p>你也许听说过，Nginx 是个轻量级的 Web 服务器，那么这个所谓的 <strong>轻量级</strong> 是什么意思呢？</p> <p>轻量级是相对于重量级而言的。重量级就是指服务器进程很重，占用很多资源，当处理 HTTP 请求时会消耗大量的 CPU 和内存，受到这些资源的限制很难提高性能。</p> <p>而 Nginx 作为轻量级的服务器，它的 CPU、内存占用都非常少，同样的资源配置下就能够为更多的用户提供服务，其奥秘在于它独特的工作模式。</p> <p><img src="/notebook/assets/img/3e94fbd78ed043e88c443f6416f99dc1.3e94fbd7.png" alt="img"></p> <p>在 Nginx 之前，Web 服务器的工作模式大多是 <code>Per-Process</code> 或者 <code>Per-Thread</code> ，对每一个请求使用单独的进程或者线程处理。这就存在创建进程或线程的成本，还会有进程、线程 <strong>上下文切换</strong> 的额外开销。如果请求数量很多，CPU 就会在多个进程、线程之间切换时疲于奔命，平白地浪费了计算时间。</p> <p>Nginx 则完全不同，一反惯例地没有使用多线程，而是使用了 <strong>进程池 + 单线程</strong> 的工作模式。</p> <p>Nginx 在启动的时候会预先创建好固定数量的 worker 进程，在之后的运行过程中不会再 fork 出新进程，这就是进程池，而且可以自动把进程 「绑定」到独立的 CPU 上，这样就完全消除了进程创建和切换的成本，能够充分利用多核 CPU 的计算能力。</p> <p>在进程池之上，还有一个 master 进程，专门用来管理进程池。它的作用有点像是 supervisor（一个用 Python 编写的进程管理工具），用来监控进程，自动恢复发生异常的 worker，保持进程池的稳定和服务能力。</p> <p>不过 master 进程完全是 Nginx 自行用 C 语言实现的，这就摆脱了外部的依赖，简化了 Nginx 的部署和配置。</p> <h2 id="i-o-多路复用"><a href="#i-o-多路复用" class="header-anchor">#</a> I/O 多路复用</h2> <p>如果你用 Java、C 等语言写过程序，一定很熟悉 <strong>多线程</strong> 的概念，使用多线程能够很容易实现并发处理。</p> <p>但多线程也有一些缺点，除了刚才说到的 「上下文切换」成本，还有编程模型复杂、数据竞争、同步等问题，写出正确、快速的多线程程序并不是一件容易的事情。</p> <p>所以 Nginx 就选择了单线程的方式，带来的好处就是开发简单，没有互斥锁的成本，减少系统消耗。</p> <p>那么，疑问也就产生了：为什么单线程的 Nginx，处理能力却能够超越其他多线程的服务器呢？</p> <p>这要归功于 Nginx 利用了 Linux 内核里的一件神兵利器，<strong>I/O 多路复用接口</strong> ，大名鼎鼎的 epoll。</p> <p>多路复用这个词我们已经在之前的 HTTP/2、HTTP/3 里遇到过好几次，如果你理解了那里的多路复用，那么面对 Nginx 的 epoll 多路复用也就好办了。</p> <p>Web 服务器从根本上来说是 <code>I/O 密集型</code> 而不是 <code>CPU 密集型</code> ，处理能力的关键在于网络收发而不是 CPU 计算（这里暂时不考虑 HTTPS 的加解密），而网络 I/O 会因为各式各样的原因不得不等待，比如数据还没到达、对端没有响应、缓冲区满发不出去等等。</p> <p>这种情形就有点像是 HTTP 里的队头阻塞。对于一般的单线程来说 CPU 就会停下来，造成浪费。而多线程的解决思路有点类似并发连接，虽然有的线程可能阻塞，但由于多个线程并行，总体上看阻塞的情况就不会太严重了。</p> <p>Nginx 里使用的 epoll，就好像是 HTTP/2 里的多路复用技术，它把多个 HTTP 请求处理打散成碎片，都复用到一个单线程里，不按照先来后到的顺序处理，而是只当连接上真正可读、可写的时候才处理，如果可能发生阻塞就立刻切换出去，处理其他的请求。</p> <p>通过这种方式，Nginx 就完全消除了 I/O 阻塞，把 CPU 利用得满满当当，又因为网络收发并不会消耗太多 CPU 计算能力，也不需要切换进程、线程，所以整体的 CPU 负载是相当低的。</p> <p>这里我画了一张 Nginx I/O 多路复用 的示意图，你可以看到，它的形式与 HTTP/2 的流非常相似，每个请求处理单独来看是分散、阻塞的，但因为都复用到了一个线程里，所以资源的利用率非常高。</p> <p><img src="/notebook/assets/img/4c6832cdce34133c9ed89237fb9d5059.4c6832cd.png" alt="img"></p> <p>epoll 还有一个特点，大量的连接管理工作都是在操作系统内核里做的，这就减轻了应用程序的负担，所以 Nginx 可以为每个连接只分配很小的内存维护状态，即使有几万、几十万的并发连接也只会消耗几百 M 内存，而其他的 Web 服务器这个时候早就 Memory not enough 了。</p> <h2 id="多阶段处理"><a href="#多阶段处理" class="header-anchor">#</a> 多阶段处理</h2> <p>有了「进程池和」、「I/O 多路复用」，Nginx 是如何处理 HTTP 请求的呢？</p> <p>Nginx 在内部也采用的是 <strong>化整为零</strong> 的思路，把整个 Web 服务器分解成了多个功能模块，就好像是乐高积木，可以在配置文件里任意拼接搭建，从而实现了高度的灵活性和扩展性。</p> <p>Nginx 的 HTTP 处理有四大类模块：</p> <ol><li>handler 模块：直接处理 HTTP 请求；</li> <li>filter 模块：不直接处理请求，而是加工过滤响应报文；</li> <li>upstream 模块：实现反向代理功能，转发请求到其他服务器；</li> <li>balance 模块：实现反向代理时的负载均衡算法。</li></ol> <p>因为 upstream 模块和 balance 模块实现的是代理功能，Nginx 作为中间人，运行机制比较复杂，所以我今天只讲 handler 模块和 filter 模块。</p> <p>不知道你有没有了解过设计模式这方面的知识，其中有一个非常有用的模式叫做 <strong>职责链</strong> 。它就好像是工厂里的流水线，原料从一头流入，线上有许多工人会进行各种加工处理，最后从另一头出来的就是完整的产品。</p> <p>Nginx 里的 handler 模块和 filter 模块就是按照职责链模式设计和组织的，HTTP 请求报文就是原材料，各种模块就是工厂里的工人，走完模块构成的流水线，出来的就是处理完成的响应报文。</p> <p>下面的这张图显示了 Nginx 的流水线，在 Nginx 里的术语叫 <strong>阶段式处理（Phases）</strong>，一共有 11 个阶段，每个阶段里又有许多各司其职的模块。</p> <p><img src="/notebook/assets/img/41318c867fda8a536d0e3db6f9987030.41318c86.png" alt="img"></p> <p>我简单列几个与我们的课程相关的模块吧：</p> <ul><li>charset 模块实现了字符集编码转换；（<a href="/notebook/http-protocol/04/01.html">海纳百川：HTTP的实体数据</a>）</li> <li>chunked 模块实现了响应数据的分块传输；（<a href="/notebook/http-protocol/04/02.html">HTTP 传输大文件的方法</a>）</li> <li>range 模块实现了范围请求，只返回数据的一部分；（<a href="/notebook/http-protocol/04/02.html">HTTP 传输大文件的方法</a>）</li> <li>rewrite 模块实现了重定向和跳转，还可以使用内置变量自定义跳转的 URI；（<a href="/notebook/http-protocol/04/04.html">HTTP 的重定向和跳转</a>）</li> <li>not_modified 模块检查头字段 <code>if-Modified-Since</code> 和 <code>If-None-Match</code> ，处理条件请求；（<a href="/notebook/http-protocol/04/06.html">HTTP 的缓存控制</a>）</li> <li>realip 模块处理 <code>X-Real-IP</code>、<code>X-Forwarded-For</code> 等字段，获取客户端的真实 IP 地址；（<a href="/notebook/http-protocol/04/07.html">HTTP 的代理服务</a>）</li> <li>ssl 模块实现了 SSL/TLS 协议支持，读取磁盘上的证书和私钥，实现 TLS 握手和 SNI、ALPN 等扩展功能；（<a href="/notebook/http-protocol/05/">安全篇</a>）</li> <li>http_v2 模块实现了完整的 HTTP/2 协议。（<a href="/notebook/http-protocol/06/">飞翔篇</a>）</li></ul> <p>在这张图里，你还可以看到 limit_conn、limit_req、access、log 等其他模块，它们实现的是限流限速、访问控制、日志等功能，不在 HTTP 协议规定之内，但对于运行在现实世界的 Web 服务器却是必备的。</p> <p>如果你有 C 语言基础，感兴趣的话可以下载 Nginx 的源码，在代码级别仔细看看 HTTP 的处理过程。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ol><li>Nginx 是一个高性能的 Web 服务器，它非常的轻量级，消耗的 CPU、内存很少；</li> <li>Nginx 采用 <code>master/workers</code> 进程池架构，不使用多线程，消除了进程、线程切换的成本；</li> <li>Nginx 基于 epoll 实现了 <code>I/O 多路复用</code> ，不会阻塞，所以性能很高；</li> <li>Nginx 使用了职责链模式，多个模块分工合作，自由组合，以流水线的方式处理 HTTP 请求。</li></ol> <h2 id="课下作业"><a href="#课下作业" class="header-anchor">#</a> 课下作业</h2> <ol><li><p>你是怎么理解进程、线程上下文切换时的成本的，为什么 Nginx 要尽量避免？</p> <p>一个线程的时间片没用完，系统调用就被系统调度切换出去，浪费了剩余的时间片，nginx 通过 epoll 和注册回调，和非阻塞 io 自己在用户态主动切换上下文，充分利用了系统分配给进程或者线程的时间片，所以对系统资源利用很充分</p></li> <li><p>试着自己描述一下 Nginx 用进程、epoll、模块流水线处理 HTTP 请求的过程。</p></li></ol> <h2 id="拓展阅读"><a href="#拓展阅读" class="header-anchor">#</a> 拓展阅读</h2> <ul><li>也有不少的人把 Nginx 读成 <code>NGks</code>，这就错得太多了。</li> <li>Nginx 自 1.7.11 开始引入了「多线程」，但只是作为辅助手段，卸载阳塞的磁盘 I/O 操作，主
要的 HTTP 请求处理使用的还是单线程里的 epoll</li> <li>如何让Web服务器能够高效地处理 10K 以上的并发请求( Concurrent 10K )，这就是著名的 C10K 问题，当然它早已经被 epo/kqueue 等解决了，现在的新问题是 C10M</li> <li>Nginx 的 PRECONTENT 阶段在 1.13.3 之前叫 TRY FILES，仅供 Nginx 内部使用，用户不可介入</li> <li>正文里的流水线图没有画出 filter  模块所在的位置，它其实是在 CONTENT 阶段的末尾，专门过滤响应数据</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zq99299/notebook/edit/man/docs/http-protocol/07/01.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-05-06 09:26:26</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notebook/http-protocol/06/04.html" class="prev">
        04 | 我应该迁移到 HTTP/2 吗？
      </a></span> <span class="next"><a href="/notebook/http-protocol/07/02.html">
        02 | OpenResty：更灵活的 Web 服务器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/notebook/assets/js/app.b6298c27.js" defer></script><script src="/notebook/assets/js/2.64eb5107.js" defer></script><script src="/notebook/assets/js/41.e918a100.js" defer></script><script src="/notebook/assets/js/50.da39fd24.js" defer></script>
  </body>
</html>
