<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>04 | 信任始于握手: TLS 1.2 连接过程解析 | NOTE-BOOK2</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/notebook/favicon.ico">
    <link rel="manifest" href="/notebook/manifest.json">
    <meta name="description" content="note-book 的第二分仓笔记仓库">
    
    <link rel="preload" href="/notebook/assets/css/0.styles.36b9479e.css" as="style"><link rel="preload" href="/notebook/assets/js/app.b6298c27.js" as="script"><link rel="preload" href="/notebook/assets/js/2.64eb5107.js" as="script"><link rel="preload" href="/notebook/assets/js/12.e186564a.js" as="script"><link rel="preload" href="/notebook/assets/js/50.da39fd24.js" as="script"><link rel="prefetch" href="/notebook/assets/js/10.f2f15088.js"><link rel="prefetch" href="/notebook/assets/js/100.b7a284fd.js"><link rel="prefetch" href="/notebook/assets/js/101.54042053.js"><link rel="prefetch" href="/notebook/assets/js/102.5bab3651.js"><link rel="prefetch" href="/notebook/assets/js/103.3d283f19.js"><link rel="prefetch" href="/notebook/assets/js/104.2fbe9651.js"><link rel="prefetch" href="/notebook/assets/js/105.3e2ec64c.js"><link rel="prefetch" href="/notebook/assets/js/106.25ccda3b.js"><link rel="prefetch" href="/notebook/assets/js/107.90cc2754.js"><link rel="prefetch" href="/notebook/assets/js/108.4e4472c8.js"><link rel="prefetch" href="/notebook/assets/js/109.8c927ccc.js"><link rel="prefetch" href="/notebook/assets/js/11.57132374.js"><link rel="prefetch" href="/notebook/assets/js/110.6e9ab0a5.js"><link rel="prefetch" href="/notebook/assets/js/111.cf4db3b8.js"><link rel="prefetch" href="/notebook/assets/js/112.db9efc72.js"><link rel="prefetch" href="/notebook/assets/js/113.bc497656.js"><link rel="prefetch" href="/notebook/assets/js/114.7b29fa0f.js"><link rel="prefetch" href="/notebook/assets/js/115.6ecd72ad.js"><link rel="prefetch" href="/notebook/assets/js/116.714ba37d.js"><link rel="prefetch" href="/notebook/assets/js/117.20fc6ca9.js"><link rel="prefetch" href="/notebook/assets/js/118.23c68cc5.js"><link rel="prefetch" href="/notebook/assets/js/119.22353b91.js"><link rel="prefetch" href="/notebook/assets/js/13.8f2e6b3f.js"><link rel="prefetch" href="/notebook/assets/js/14.5af7e630.js"><link rel="prefetch" href="/notebook/assets/js/15.2ee25eab.js"><link rel="prefetch" href="/notebook/assets/js/16.0f760848.js"><link rel="prefetch" href="/notebook/assets/js/17.82010583.js"><link rel="prefetch" href="/notebook/assets/js/18.94bb2fcd.js"><link rel="prefetch" href="/notebook/assets/js/19.8d83e367.js"><link rel="prefetch" href="/notebook/assets/js/20.9853e81d.js"><link rel="prefetch" href="/notebook/assets/js/21.a60e512a.js"><link rel="prefetch" href="/notebook/assets/js/22.0a718618.js"><link rel="prefetch" href="/notebook/assets/js/23.d0085c3c.js"><link rel="prefetch" href="/notebook/assets/js/24.64c99be0.js"><link rel="prefetch" href="/notebook/assets/js/25.7f138222.js"><link rel="prefetch" href="/notebook/assets/js/26.c38b4f1f.js"><link rel="prefetch" href="/notebook/assets/js/27.3c23ee36.js"><link rel="prefetch" href="/notebook/assets/js/28.17a30eb5.js"><link rel="prefetch" href="/notebook/assets/js/29.1080ae7e.js"><link rel="prefetch" href="/notebook/assets/js/3.39c53e9a.js"><link rel="prefetch" href="/notebook/assets/js/30.e12e7194.js"><link rel="prefetch" href="/notebook/assets/js/31.1b4d10d3.js"><link rel="prefetch" href="/notebook/assets/js/32.088b464e.js"><link rel="prefetch" href="/notebook/assets/js/33.b6d5b301.js"><link rel="prefetch" href="/notebook/assets/js/34.07a7bd18.js"><link rel="prefetch" href="/notebook/assets/js/35.c1778ec0.js"><link rel="prefetch" href="/notebook/assets/js/36.9c952bcf.js"><link rel="prefetch" href="/notebook/assets/js/37.538120d6.js"><link rel="prefetch" href="/notebook/assets/js/38.379b1ac9.js"><link rel="prefetch" href="/notebook/assets/js/39.9825dc44.js"><link rel="prefetch" href="/notebook/assets/js/4.80b43ba9.js"><link rel="prefetch" href="/notebook/assets/js/40.7502629c.js"><link rel="prefetch" href="/notebook/assets/js/41.e918a100.js"><link rel="prefetch" href="/notebook/assets/js/42.6d79fd40.js"><link rel="prefetch" href="/notebook/assets/js/43.f40c79b3.js"><link rel="prefetch" href="/notebook/assets/js/44.66b4fb8b.js"><link rel="prefetch" href="/notebook/assets/js/45.58d7b7db.js"><link rel="prefetch" href="/notebook/assets/js/46.3e86cb70.js"><link rel="prefetch" href="/notebook/assets/js/47.1ceb15d6.js"><link rel="prefetch" href="/notebook/assets/js/48.7405fe2c.js"><link rel="prefetch" href="/notebook/assets/js/49.f512df2d.js"><link rel="prefetch" href="/notebook/assets/js/5.a817fe71.js"><link rel="prefetch" href="/notebook/assets/js/51.1befb9db.js"><link rel="prefetch" href="/notebook/assets/js/52.ee2cc35e.js"><link rel="prefetch" href="/notebook/assets/js/53.b7d4d642.js"><link rel="prefetch" href="/notebook/assets/js/54.7597b610.js"><link rel="prefetch" href="/notebook/assets/js/55.b99d68c9.js"><link rel="prefetch" href="/notebook/assets/js/56.3260f107.js"><link rel="prefetch" href="/notebook/assets/js/57.4c3d32ae.js"><link rel="prefetch" href="/notebook/assets/js/58.858f5030.js"><link rel="prefetch" href="/notebook/assets/js/59.5bb43d22.js"><link rel="prefetch" href="/notebook/assets/js/6.e66ff3e3.js"><link rel="prefetch" href="/notebook/assets/js/60.604f3715.js"><link rel="prefetch" href="/notebook/assets/js/61.133da1fe.js"><link rel="prefetch" href="/notebook/assets/js/62.b9d97f09.js"><link rel="prefetch" href="/notebook/assets/js/63.b54ac379.js"><link rel="prefetch" href="/notebook/assets/js/64.11aa21b9.js"><link rel="prefetch" href="/notebook/assets/js/65.f7fc56f3.js"><link rel="prefetch" href="/notebook/assets/js/66.11cdb117.js"><link rel="prefetch" href="/notebook/assets/js/67.c393eaf5.js"><link rel="prefetch" href="/notebook/assets/js/68.ee9541b2.js"><link rel="prefetch" href="/notebook/assets/js/69.d3d86051.js"><link rel="prefetch" href="/notebook/assets/js/7.cf57fdd5.js"><link rel="prefetch" href="/notebook/assets/js/70.8466e474.js"><link rel="prefetch" href="/notebook/assets/js/71.e4c9766c.js"><link rel="prefetch" href="/notebook/assets/js/72.efa3abc7.js"><link rel="prefetch" href="/notebook/assets/js/73.534593d2.js"><link rel="prefetch" href="/notebook/assets/js/74.74bf2cc7.js"><link rel="prefetch" href="/notebook/assets/js/75.84a69486.js"><link rel="prefetch" href="/notebook/assets/js/76.6a4151a2.js"><link rel="prefetch" href="/notebook/assets/js/77.bc69de12.js"><link rel="prefetch" href="/notebook/assets/js/78.ef857f92.js"><link rel="prefetch" href="/notebook/assets/js/79.a994a308.js"><link rel="prefetch" href="/notebook/assets/js/8.1e1b7412.js"><link rel="prefetch" href="/notebook/assets/js/80.bb3ad06d.js"><link rel="prefetch" href="/notebook/assets/js/81.65c1333d.js"><link rel="prefetch" href="/notebook/assets/js/82.261800cd.js"><link rel="prefetch" href="/notebook/assets/js/83.44998c31.js"><link rel="prefetch" href="/notebook/assets/js/84.85b6a88a.js"><link rel="prefetch" href="/notebook/assets/js/85.9a33a277.js"><link rel="prefetch" href="/notebook/assets/js/86.1d5b478f.js"><link rel="prefetch" href="/notebook/assets/js/87.a2ea9583.js"><link rel="prefetch" href="/notebook/assets/js/88.aa84de6d.js"><link rel="prefetch" href="/notebook/assets/js/89.9f568c0c.js"><link rel="prefetch" href="/notebook/assets/js/9.bfb9d1de.js"><link rel="prefetch" href="/notebook/assets/js/90.83f66c97.js"><link rel="prefetch" href="/notebook/assets/js/91.7eec9066.js"><link rel="prefetch" href="/notebook/assets/js/92.edafca68.js"><link rel="prefetch" href="/notebook/assets/js/93.a12f5c78.js"><link rel="prefetch" href="/notebook/assets/js/94.bdaa08e2.js"><link rel="prefetch" href="/notebook/assets/js/95.37064771.js"><link rel="prefetch" href="/notebook/assets/js/96.610fe9bd.js"><link rel="prefetch" href="/notebook/assets/js/97.5f6322c4.js"><link rel="prefetch" href="/notebook/assets/js/98.175c6f9c.js"><link rel="prefetch" href="/notebook/assets/js/99.e9545cc8.js">
    <link rel="stylesheet" href="/notebook/assets/css/0.styles.36b9479e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><img src="/notebook/mlogo.svg" alt="NOTE-BOOK2" class="logo"> <span class="site-name can-hide">NOTE-BOOK2</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/monitor-tuning/" class="nav-link">
  JAVA 生产环境下性能监控与调优详解
</a></div><div class="nav-item"><a href="/notebook/http-protocol/" class="nav-link router-link-active">
  透视 HTTP 协议
</a></div><div class="nav-item"><a href="/notebook/ddd/" class="nav-link">
  DDD 实战课
</a></div> <a href="https://github.com/nianien/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook/monitor-tuning/" class="nav-link">
  JAVA 生产环境下性能监控与调优详解
</a></div><div class="nav-item"><a href="/notebook/http-protocol/" class="nav-link router-link-active">
  透视 HTTP 协议
</a></div><div class="nav-item"><a href="/notebook/ddd/" class="nav-link">
  DDD 实战课
</a></div> <a href="https://github.com/nianien/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/notebook/http-protocol/" aria-current="page" class="sidebar-link">透视 HTTP 协议</a></li><li><a href="/notebook/http-protocol/01/" class="sidebar-link">01 | 开篇: To Be a HTTP Hero</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/02/" class="sidebar-heading clickable"><span>02 | 破冰篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/03/" class="sidebar-heading clickable"><span>03 | 基础篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/04/" class="sidebar-heading clickable"><span>04 | 进阶篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/05/" class="sidebar-heading clickable router-link-active open"><span>05 | 安全篇</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/http-protocol/05/01.html" class="sidebar-link">01 | TLS 又是什么？</a></li><li><a href="/notebook/http-protocol/05/02.html" class="sidebar-link">02 | 固若金汤的根本: 对称加密与非对称加密</a></li><li><a href="/notebook/http-protocol/05/03.html" class="sidebar-link">03 | 固若金汤的根本: 数字签名与证书</a></li><li><a href="/notebook/http-protocol/05/04.html" aria-current="page" class="active sidebar-link">04 | 信任始于握手: TLS 1.2 连接过程解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#https-建立连接" class="sidebar-link">HTTPS 建立连接</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#tls-协议的组成" class="sidebar-link">TLS 协议的组成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#记录协议" class="sidebar-link">记录协议</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#警报协议" class="sidebar-link">警报协议</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#握手协议" class="sidebar-link">握手协议</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#变更密码规范协议" class="sidebar-link">变更密码规范协议</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#tls-的握手过程" class="sidebar-link">TLS 的握手过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#抓包的准备工作" class="sidebar-link">抓包的准备工作</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#ecdhe-握手过程" class="sidebar-link">ECDHE 握手过程</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#rsa-握手过程" class="sidebar-link">RSA 握手过程</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#双向认证" class="sidebar-link">双向认证</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#课下作业" class="sidebar-link">课下作业</a></li><li class="sidebar-sub-header"><a href="/notebook/http-protocol/05/04.html#拓展阅读" class="sidebar-link">拓展阅读</a></li></ul></li><li><a href="/notebook/http-protocol/05/05.html" class="sidebar-link">05 | 更好更快的握手: TLS 1.3 特性解析</a></li><li><a href="/notebook/http-protocol/05/06.html" class="sidebar-link">06 | 连接太慢该怎么办 HTTPS 的优化</a></li><li><a href="/notebook/http-protocol/05/07.html" class="sidebar-link">07 | 我应该迁移到 HTTPS 吗？</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/06/" class="sidebar-heading clickable"><span>06 | 飞翔篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notebook/http-protocol/07/" class="sidebar-heading clickable"><span>07 | 探索篇</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/notebook/http-protocol/08/" class="sidebar-link">08 | 总结篇: HTTP 性能优化面面观</a></li><li><a href="/notebook/http-protocol/09.html" class="sidebar-link">参考资源</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_04-信任始于握手-tls-1-2-连接过程解析"><a href="#_04-信任始于握手-tls-1-2-连接过程解析" class="header-anchor">#</a> 04 | 信任始于握手: TLS 1.2 连接过程解析</h1> <p>经过前几讲的介绍，你应该已经熟悉了对称加密与非对称加密、数字签名与证书等密码学知识。</p> <p>有了这些知识打底，现在我们就可以正式开始研究 HTTPS 和 TLS 协议了。</p> <h2 id="https-建立连接"><a href="#https-建立连接" class="header-anchor">#</a> HTTPS 建立连接</h2> <p>当你在浏览器地址栏里键入<strong>https</strong> 开头的 URI，再按下回车，会发生什么呢？</p> <p>回忆一下 <a href="/notebook/http-protocol/03/01.html">键入网址再按下回车，后面究竟发生了什么？</a> 的内容，你应该知道，浏览器首先要从 URI 里提取出协议名和域名。因为协议名是 <code>https</code> ，所以浏览器就知道了端口号是默认的 443，它再用 DNS 解析域名，得到目标的 IP 地址，然后就可以使用 <strong>三次握手与网站建立 TCP 连接</strong> 了。</p> <p>在 HTTP 协议里，建立连接后，浏览器会立即发送请求报文。但现在是 HTTPS 协议，它需要再用另外一个 「<strong>握手</strong>」过程，在 TCP 上建立安全连接，之后才是收发 HTTP 报文。</p> <p>这个其实就类似于 mysql 服务端客户端交互协议中的登录握手了，也是当 TCP 建立连接后，还需要发送握手包协商登录密码相关的加密解密算法，验证之后确定该连接可以进行后面的通信。</p> <p>这个「握手」过程与 TCP 有些类似，是 HTTPS 和 TLS 协议里最重要、最核心的部分，懂了它，你就可以自豪地说自己 「掌握了 HTTPS」。</p> <h2 id="tls-协议的组成"><a href="#tls-协议的组成" class="header-anchor">#</a> TLS 协议的组成</h2> <p>在讲 TLS 握手之前，我先简单介绍一下 TLS 协议的组成。</p> <p>TLS 包含几个子协议，你也可以理解为它是由几个不同职责的模块组成，比较常用的有记录协议、警报协议、握手协议、变更密码规范协议等。</p> <h3 id="记录协议"><a href="#记录协议" class="header-anchor">#</a> 记录协议</h3> <p><strong>记录协议</strong>（Record Protocol）规定了 TLS 收发数据的基本单位：记录（record）。它有点像是 TCP 里的 segment，所有的其他子协议都需要通过记录协议发出。但多个记录数据可以在一个 TCP 包里一次性发出，也并不需要像 TCP 那样返回 ACK。</p> <h3 id="警报协议"><a href="#警报协议" class="header-anchor">#</a> 警报协议</h3> <p><strong>警报协议</strong>（Alert Protocol）的职责是向对方发出警报信息，有点像是 HTTP 协议里的状态码。比如，protocol_version 就是不支持旧版本，bad_certificate 就是证书有问题，收到警报后另一方可以选择继续，也可以立即终止连接。</p> <h3 id="握手协议"><a href="#握手协议" class="header-anchor">#</a> 握手协议</h3> <p><strong>握手协议</strong>（Handshake Protocol）是 TLS 里最复杂的子协议，要比 TCP 的 SYN/ACK 复杂的多，浏览器和服务器会在握手过程中协商 TLS 版本号、随机数、密码套件等信息，然后交换证书和密钥参数，最终双方协商得到会话密钥，用于后续的混合加密系统。</p> <h3 id="变更密码规范协议"><a href="#变更密码规范协议" class="header-anchor">#</a> 变更密码规范协议</h3> <p>最后一个是 <strong>变更密码规范协议</strong>（Change Cipher Spec Protocol），它非常简单，就是一个「通知」，告诉对方，后续的数据都将使用加密保护。那么反过来，在它之前，数据都是明文的。</p> <h3 id="tls-的握手过程"><a href="#tls-的握手过程" class="header-anchor">#</a> TLS 的握手过程</h3> <p>下面的这张图简要地描述了 TLS 的握手过程，其中每一个「框」都是一个记录，多个记录组合成一个 TCP 包发送。所以，最多经过两次消息往返（4 个消息）就可以完成握手，然后就可以在安全的通信环境里发送 HTTP 报文，实现 HTTPS 协议。</p> <p><img src="/notebook/assets/img/69493b53f1b1d540acf886ebf021a26c.69493b53.png" alt="img"></p> <h2 id="抓包的准备工作"><a href="#抓包的准备工作" class="header-anchor">#</a> 抓包的准备工作</h2> <p>这次我们在实验环境里测试 TLS 握手的 URI 是 <code>https://www.chrono.com//26-1</code>，看了上面的图你就可以知道，TLS 握手的前几个消息都是明文的，能够在 Wireshark 里直接看。但只要出现了 <code>Change Cipher Spec</code> ，后面的数据就都是密文了，看到的也就会是乱码，不知道究竟是什么东西。</p> <p><img src="/notebook/assets/img/image-20210310105548742.a7dec2fb.png" alt="image-20210310105548742"></p> <p>上述笔者抓包和上面图的流程是一致的，从最前面的标示线来看，也的确是这样。Change Cipher Spec 后面就是密文了</p> <p>为了更好地分析 TLS 握手过程，你可以再对系统和 Wireshark 做一下设置，让浏览器导出握手过程中的秘密信息，这样 Wireshark 就可以把密文解密，还原出明文。</p> <p>首先，你需要在 Windows 的设置里新增一个系统变量 <strong>SSLKEYLOGFILE</strong> ，设置浏览器日志文件的路径，比如 <code>D:\http_study\www\temp\sslkey.log</code> （具体的设置过程就不详细说了，可以在设置里搜索“系统变量”）。</p> <p><img src="/notebook/assets/img/70b36338611d5a249a7d2fc448f06d42.70b36338.png" alt="img"></p> <p>然后在 Wireshark 设置 <code>Protocols-TLS</code>（较早版本的 Wireshark 里是 <code>SSL</code> ），在 <code>(Pre)-Master-Secret log filename</code> 里填上刚才的日志文件。</p> <p>设置好之后，过滤器选择 <strong>tcp port 443</strong>，就可以抓到实验环境里的所有 HTTPS 数据了。</p> <p><img src="/notebook/assets/img/image-20210310111820297.4db22939.png" alt="image-20210310111820297"></p> <p><img src="/notebook/assets/img/0274e31e74e92b61892ec11cc3cd58e7.0274e31e.png" alt="img"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>日志配置后，需要知道的事情有：</p> <ol><li>环境变量的配置只支持  Chrome 浏览器</li> <li>浏览器需要重新启动后，访问实验室环境的 https 才会往 log 中写入数据</li></ol></div> <p>如果你觉得麻烦也没关系，GitHub 上有抓好的包和相应的日志，用 Wireshark 直接打开就行。</p> <h2 id="ecdhe-握手过程"><a href="#ecdhe-握手过程" class="header-anchor">#</a> ECDHE 握手过程</h2> <p>刚才你看到的是握手过程的简要图，我又画了一个详细图，对应 Wireshark 的抓包，下面我就用这个图来仔细剖析 TLS 的握手过程。</p> <p><img src="/notebook/assets/img/9caba6d4b527052bbe7168ed4013011e.9caba6d4.png" alt="img"></p> <p><img src="/notebook/assets/img/image-20210310112426920.e26130c3.png" alt="image-20210310112426920"></p> <p>如果你需要自己抓包查看，笔者这边写了过滤参数是 <code>tcp.port == 443 || ip eq 127.0.0.1</code> 因为可能计算器上链接了其他的 443 端口之类的，只过滤出本机的。另外看它的握手包所在位置，不然不好对应文章中的讲解</p> <p>在 TCP 建立连接之后，浏览器会首先发一个 <strong>Client Hello</strong> 消息，也就是跟服务器打招呼。里面有客户端的版本号、支持的密码套件，还有一个 <strong>随机数（Client Random）</strong> ，用于后续生成会话密钥。</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>Handshake Protocol: Client Hello
    Version: TLS 1.2 (0x0303)
    Random: 1cbf803321fd2623408dfe…
    Cipher Suites (17 suites)
        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)
        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个的意思就是：我这边有这些这些信息，你看看哪些是能用的，关键的 <strong>随机数可得留着</strong> 。</p> <p>作为礼尚往来，服务器收到 <code>Client Hello</code> 后，会返回一个 <code>Server Hello</code> 消息。把版本号对一下，也给出一个 <strong>随机数（Server Random）</strong> ，然后从客户端的列表里选一个作为本次通信使用的密码套件，在这里它选择了 <code>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</code></p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>Handshake Protocol: Server Hello
    Version: TLS 1.2 (0x0303)
    Random: 0e6320f21bae50842e96…
    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个的意思就是：版本号对上了，可以加密，你的密码套件挺多，我选一个最合适的吧，用椭圆曲线加 RSA、AES、SHA384。我也 <strong>给你一个随机数，你也得留着</strong></p> <p>然后，服务器为了证明自己的身份，就把证书也发给了客户端（Server Certificate）</p> <p><img src="/notebook/assets/img/image-20210310113404586.37a38a87.png" alt="image-20210310113404586"></p> <p>接下来是一个关键的操作，因为服务器选择了 ECDHE 算法，所以它会在证书后发送 <strong>Server Key Exchange</strong> 消息，里面是 <strong>椭圆曲线的公钥（Server Params）</strong> ，用来实现密钥交换算法，再加上自己的私钥签名认证。</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>Handshake Protocol: Server Key Exchange
    EC Diffie-Hellman Server Params
        Curve Type: named_curve (0x03)
        Named Curve: x25519 (0x001d)
        Pubkey: 3b39deaf00217894e...
        Signature Algorithm: rsa_pkcs1_sha512 (0x0601)
        Signature: 37141adac38ea4...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这相当于说：刚才我选的密码套件有点复杂，所以再给你个算法的参数，和刚才的随机数一样有用，别丢了。为了防止别人冒充，我又盖了个章。</p> <p>之后是 <strong>Server Hello Done</strong> 消息，服务器说：我的信息就是这些，打招呼完毕。</p> <p>这样第一个消息往返就结束了（两个 TCP 包），结果是客户端和服务器通过明文共享了三个信息：<strong>Client Random、Server Random 和 Server Params</strong> 。</p> <p>客户端这时也拿到了服务器的证书，那这个证书是不是真实有效的呢？</p> <p>这就要用到上一讲里的知识了，开始走证书链逐级验证，确认证书的真实性，再用证书公钥验证签名，就确认了服务器的身份：刚才跟我打招呼的不是骗子，可以接着往下走。</p> <p>然后，客户端按照密码套件的要求，也生成一个 <strong>椭圆曲线的公钥（Client Params）</strong> ，用 <strong>Client Key Exchange</strong> 消息发给服务器。</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>Handshake Protocol: Client Key Exchange
    EC Diffie-Hellman Client Params
        Pubkey: 8c674d0e08dc27b5eaa…
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在客户端和服务器手里都拿到了密钥交换算法的两个参数（Client Params、Server Params），就用 ECDHE 算法一阵算，算出了一个新的东西，叫 <strong>Pre-Master</strong> ，其实也是一个随机数。</p> <p>至于具体的计算原理和过程，因为太复杂就不细说了，但算法可以保证即使黑客截获了之前的参数，也是绝对算不出这个随机数的。</p> <p>现在客户端和服务器手里有了三个随机数：<strong>Client Random、Server Random 和 Pre-Master</strong> 。用这三个作为原始材料，就可以生成用于加密会 话的主密钥，叫 <strong>Master Secret</strong> 。而黑客因为拿不到 <code>Pre-Master</code> ，所以也就得不到主密钥。</p> <p>为什么非得这么麻烦，非要三个随机数呢？</p> <p>这就必须说 TLS 的设计者考虑得非常周到了，<strong>他们不信任客户端或服务器伪随机数的可靠性</strong> ，为了保证真正的 <strong>完全随机、不可预测</strong> ，把三个不可靠的随机数混合起来，那么随机的程度就非常高了，足够让黑客难以猜测。</p> <p>你一定很想知道 <code>Master Secret</code> 究竟是怎么算出来的吧，贴一下 RFC 里的公式：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>master_secret = PRF(pre_master_secret, &quot;master secret&quot;,
                    ClientHello.random + ServerHello.random)

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里的 <code>PRF</code> 就是伪随机数函数，它基于密码套件里的最后一个参数，比如这次的 SHA384，通过摘要算法来再一次强化 <code>Master Secret</code> 的随机性。</p> <p>主密钥有 48 字节，但它也不是最终用于通信的会话密钥，还会再用 PRF 扩展出更多的密钥，比如客户端发送用的会话密钥（client_write_key）、服务器发送用的会话密钥（server_write_key）等等，避免只用一个密钥带来的安全隐患。</p> <p>有了主密钥和派生的会话密钥，握手就快结束了。客户端发一个 <strong>Change Cipher Spec</strong> ，然后再发一个 <strong>Finished</strong> 消息，把之前所有发送的数据做个摘要，再加密一下，让服务器做个验证。</p> <p>意思就是告诉服务器：后面都改用对称算法加密通信了啊，用的就是打招呼时说的 AES，加密对不对还得你测一下。</p> <p>服务器也是同样的操作，发 <strong>Change Cipher Spec</strong> 和 <strong>Finished</strong> 消息，双方都验证加密解密 OK，握手正式结束，后面就收发被加密的 HTTP 请求和响应了。</p> <h2 id="rsa-握手过程"><a href="#rsa-握手过程" class="header-anchor">#</a> RSA 握手过程</h2> <p>整个握手过程可真是够复杂的，但你可能会问了，好像这个过程和其他地方看到的不一样呢？</p> <p>刚才说的其实是如今主流的 TLS 握手过程，这与传统的握手有两点不同。</p> <p>第一个，使用 ECDHE 实现密钥交换，而不是 RSA，所以会在服务器端发出 <code>Server Key Exchange</code> 消息。</p> <p>第二个，因为使用了 ECDHE，客户端可以不用等到服务器发回 <code>Finished</code> 确认握手完毕，立即就发出 HTTP 报文，省去了一个消息往返的时间浪费。这个叫 <strong>TLS False Start</strong> ，意思就是抢跑，和 <code>TCP Fast Open</code> 有点像，都是不等连接完全建立就提前发应用数据，提高传输的效率。</p> <p>实验环境在 440 端口（<code>https://www.chrono.com:440/26-1</code>）实现了传统的 RSA 密钥交换，没有 <code>False Start</code> ，你可以课后自己抓包看一下，这里我也画了个图。</p> <p><img src="/notebook/assets/img/cb9a89055eadb452b7835ba8db7c3ad2.cb9a8905.png" alt="img"></p> <p>大体的流程没有变，只是 <code>Pre-Master</code> 不再需要用算法生成，而是客户端直接生成随机数，然后用服务器的公钥加密，通过 <strong>Client Key Exchange</strong> 消息发给服务器。服务器再用私钥解密，这样双方也实现了共享三个随机数，就可以生成主密钥。</p> <p>这个相对简单一点，下面是流程：</p> <ol><li><p>客户端连上服务端</p></li> <li><p>服务端发送 CA 证书给客户端</p> <p>发送的是一个 CA 链，不包含 ROOT 证书</p></li> <li><p>客户端验证该证书的可靠性</p> <p>解析 CA 链，用链条上的 CA 进行验证，一层层地验证，直到找到根证书，就能够确定证书是可信的</p></li> <li><p>客户端从 CA 证书中取出公钥</p></li> <li><p>客户端生成一个随机密钥 k，并用这个公钥加密得到 <code>k*</code></p></li> <li><p>客户端把 <code>k*</code> 发送给服务端</p></li> <li><p>服务端收到 <code>k*</code> 后用自己的私钥解密得到 k</p></li> <li><p>此时双方都得到了密钥 k，协商完成</p></li> <li><p>后续使用密钥 <code>k*</code> 加密信息</p></li></ol> <p>攻击方式：</p> <ul><li><p>防偷窥（嗅探）</p> <p>攻击者虽然可以监视网络流量并拿到公钥，但是 <strong>无法</strong> 通过公钥推算出私钥（这点由 RSA 算法保证）</p> <p>攻击者虽然可以监视网络流量并拿到 <code>k*</code>，但是攻击者没有私钥，<strong>无法解密 <code>k*</code></strong> ，因此也就无法得到 k</p></li> <li><p>如何防范篡改（假冒身份）</p> <p>如果攻击者在第 2 步篡改数据，伪造了证书，那么客户端在第 3 步会发现（这点由证书体系保证）</p> <p>如果攻击者在第 6 步篡改数据，伪造了 <code>k*</code> ，那么服务端收到假的 <code>k*</code> 之后，解密会失败（这点由 RSA 算法保证）。服务端就知道被攻击了。</p></li></ul> <h2 id="双向认证"><a href="#双向认证" class="header-anchor">#</a> 双向认证</h2> <p>到这里 TLS 握手就基本讲完了。</p> <p>不过上面说的是 <strong>单向认证</strong> 握手过程，只认证了服务器的身份，而没有认证客户端的身份。这是因为通常单向认证通过后已经建立了安全通信，用账号、密码等简单的手段就能够确认用户的真实身份。</p> <p>但为了防止账号、密码被盗，有的时候（比如网上银行）还会使用 U 盾给用户颁发客户端证书，实现 <strong>双向认证</strong> ，这样会更加安全。</p> <p>双向认证的流程也没有太多变化，只是在 <strong>Server Hello Done</strong> 之后，<strong>Client Key Exchange</strong> 之前，客户端要发送 <strong>Client Certificate</strong> 消息，服务器收到后也把证书链走一遍，验证客户端的身份。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>今天我们学习了 HTTPS/TLS 的握手，内容比较多、比较难，不过记住下面四点就可以。</p> <ol><li>HTTPS 协议会先与服务器执行 TCP 握手，然后执行 TLS 握手，才能建立安全连接；</li> <li>握手的目标是安全地交换对称密钥，需要三个随机数，第三个随机数 <code>Pre-Master</code> 必须加密传输，绝对不能让黑客破解；</li> <li><code>Hello</code> 消息交换随机数，<code>Key Exchange</code> 消息交换 <code>Pre-Master</code> ；</li> <li><code>Change Cipher Spec</code> 之前传输的都是明文，之后都是对称密钥加密的密文。</li></ol> <h2 id="课下作业"><a href="#课下作业" class="header-anchor">#</a> 课下作业</h2> <ol><li>密码套件里的那些算法分别在握手过程中起了什么作用？</li> <li>你能完整地描述一下 RSA 的握手过程吗？</li> <li>你能画出双向认证的流程图吗？</li></ol> <h2 id="拓展阅读"><a href="#拓展阅读" class="header-anchor">#</a> 拓展阅读</h2> <ul><li>TLS 中记录协议原本定义有压缩方式，但后来发现存在安全漏洞（CRME 攻击），所以现在这个字段总是 NULL，即不压缩。</li> <li>在 TLS1.2 里,客户端和随机数的长度都是 28 字节，前面的四个字节是 UNX 时间戳，但并没有实际意义。</li> <li>Chrome 开发者工具的 <code>Security</code> 面板里可以看到 Https 握手时选择的版本号、密码套件和椭圆曲线，例如 <code>ECDHE_RSA With X25519，and AES_256_GCM</code></li> <li>ECDHE 即 「短暂-椭圆曲线-迪菲-赫尔曼」(ephemeral Elliptic Curve Diffe-Hellman) 算法，使用椭圆曲线增强了DH 算法的安全性和性能，公钥和私钥都是临时生成的。</li> <li>在 Wireshark 抓包里你还会看见 <code>Session iD</code>、<code>Extension</code> 等字段，涉及会话复用和扩展协议，后面会讲到。</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zq99299/notebook/edit/man/docs/http-protocol/05/04.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-05-06 09:26:26</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notebook/http-protocol/05/03.html" class="prev">
        03 | 固若金汤的根本: 数字签名与证书
      </a></span> <span class="next"><a href="/notebook/http-protocol/05/05.html">
        05 | 更好更快的握手: TLS 1.3 特性解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/notebook/assets/js/app.b6298c27.js" defer></script><script src="/notebook/assets/js/2.64eb5107.js" defer></script><script src="/notebook/assets/js/12.e186564a.js" defer></script><script src="/notebook/assets/js/50.da39fd24.js" defer></script>
  </body>
</html>
